<!-- ODIN — Crypto Futures Swing Trading Bot -->
<div class="tab-content" id="tab-odin">

  <!-- A: Intel Meter + Header -->
  <div id="intel-odin" class="intel-meter" style="margin-bottom:12px;"></div>
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
    <span id="odin-mode-badge" class="trading-mode-badge trading-mode-paper">Trading: Paper Money</span>
    <button class="trading-mode-toggle" id="odin-mode-toggle" onclick="toggleOdinMode()">Switch</button>
    <span id="odin-cycle-timer" style="display:inline-flex;align-items:center;gap:7px;font-family:var(--font-mono);font-size:0.82rem;font-weight:700;padding:6px 16px;border-radius:999px;border:1px solid rgba(139,92,246,0.35);background:rgba(139,92,246,0.12);color:var(--agent-odin);transition:box-shadow .3s;">
      <span style="width:8px;height:8px;border-radius:50%;background:var(--agent-odin);animation:rxPulse 2s ease-in-out infinite;"></span>
      Next Cycle: <span id="odin-cycle-countdown" style="min-width:38px;text-align:center;">--</span>
    </span>
    <span class="text-muted" style="font-size:0.68rem;font-style:italic;margin-left:auto;">"I see everything. I forget nothing."</span>
  </div>

  <!-- B: Action Bar -->
  <div class="agent-widget-row">
    <button class="btn" onclick="odinRefresh()" style="font-size:0.72rem;font-weight:700;border-color:var(--agent-odin);color:var(--agent-odin);">Refresh Status</button>
    <button class="btn" onclick="healthCheckAgent('odin')" style="font-size:0.72rem;">Health Check</button>
    <span style="margin-left:auto;display:flex;align-items:center;gap:6px;">
      <input type="text" id="odin-omni-input" placeholder="Coin (e.g. BTC)" style="width:110px;padding:4px 10px;font-size:0.72rem;border:1px solid var(--agent-odin);border-radius:4px;background:transparent;color:var(--text-primary);">
      <button class="btn" onclick="odinRunOmniCoin()" style="font-size:0.72rem;font-weight:700;border-color:var(--agent-odin);color:#fff;background:var(--agent-odin);">OmniCoin Analyzer</button>
    </span>
  </div>
  <div class="health-inline" id="odin-health-result"></div>

  <!-- B2: OmniCoin Analyzer Results -->
  <div id="odin-omnicoin-section" class="glass-card" style="margin-bottom:12px;border-left:3px solid var(--agent-odin);display:none;">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
      <h3 class="section-title" style="font-size:0.76rem;margin:0;text-transform:uppercase;letter-spacing:0.06em;color:var(--agent-odin);">OmniCoin Analysis: <span id="odin-omni-symbol">--</span></h3>
      <span id="odin-omni-confidence" style="font-weight:700;font-size:1rem;padding:2px 10px;border-radius:6px;background:rgba(139,92,246,0.15);color:var(--agent-odin);">--/10</span>
      <span id="odin-omni-bias" class="badge" style="font-size:0.64rem;font-weight:700;padding:2px 10px;">--</span>
      <span id="odin-omni-time" class="text-muted" style="font-size:0.64rem;margin-left:auto;">--</span>
    </div>
    <div id="odin-omni-summary" style="font-size:0.76rem;margin-bottom:10px;line-height:1.5;color:var(--text-primary);"></div>
    <div id="odin-omni-sections" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
    </div>
    <div id="odin-omni-loading" style="display:none;text-align:center;padding:20px;color:var(--agent-odin);font-size:0.8rem;">
      Analyzing... <span style="animation:pulse 1.5s infinite;">&#9679;</span>
    </div>
  </div>

  <!-- C: Hero Cards -->
  <div class="grid-3" style="margin-bottom:12px;">
    <div class="stat-card" data-accent="odin">
      <div class="stat-value" id="odin-balance" style="font-size:1.4rem;color:var(--agent-odin);">$1,000</div>
      <div class="stat-label">Balance</div>
    </div>
    <div class="stat-card" data-accent="odin">
      <div class="stat-value" id="odin-total-pnl" style="font-size:1.4rem;">$0.00</div>
      <div class="stat-label">Total P&amp;L</div>
    </div>
    <div class="stat-card" data-accent="odin">
      <div class="stat-value" id="odin-exposure" style="font-size:1.4rem;">$0.00</div>
      <div class="stat-label">Exposure</div>
    </div>
  </div>

  <!-- D: CoinGlass Regime -->
  <div class="glass-card" style="margin-bottom:12px;border-left:3px solid var(--agent-odin);">
    <h3 class="section-title" style="font-size:0.72rem;margin-bottom:var(--space-2);text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);">CoinGlass Regime</h3>
    <div class="grid-6" style="margin-bottom:0;">
      <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-regime" style="font-size:0.9rem;color:var(--agent-odin);">--</div><div class="stat-label">Regime</div></div>
      <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-regime-score">50</div><div class="stat-label">Score (0-100)</div></div>
      <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-regime-bias">--</div><div class="stat-label">Direction</div></div>
      <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-regime-opps">0</div><div class="stat-label">Opportunities</div></div>
      <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-top-short">--</div><div class="stat-label">Top Short</div></div>
      <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-top-long">--</div><div class="stat-label">Top Long</div></div>
    </div>
  </div>

  <!-- D2: Opportunities -->
  <div class="collapse-section default-open">
    <div class="collapse-trigger">
      <h2 class="section-title" data-accent="odin" style="margin-bottom:0;">Regime Opportunities</h2>
    </div>
    <div class="collapse-body">
      <table class="data-table">
        <thead><tr><th>Symbol</th><th>Direction</th><th>Score</th><th>Reasons</th></tr></thead>
        <tbody id="odin-opps-tbody"><tr><td colspan="4" class="text-muted">No opportunities detected</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- G: Open Positions (moved above stats) -->
  <div class="collapse-section default-open">
    <div class="collapse-trigger">
      <h2 class="section-title" data-accent="odin" style="margin-bottom:0;">Open Positions <span id="odin-positions-badge" style="font-size:0.56rem;font-weight:700;padding:2px 8px;border-radius:4px;margin-left:8px;background:rgba(243,156,18,0.15);border:1px solid var(--warning);color:var(--warning);vertical-align:middle;">PAPER</span></h2>
    </div>
    <div class="collapse-body">
      <table class="data-table">
        <thead><tr><th>Asset</th><th>Dir</th><th>Leverage</th><th>Entry</th><th>Now</th><th>SL</th><th>TP</th><th>Qty</th><th>Margin</th><th>P&amp;L</th></tr></thead>
        <tbody id="odin-positions-tbody"><tr><td colspan="10" class="text-muted">No open positions</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- I: Trade History (moved above stats) -->
  <div class="collapse-section default-open">
    <div class="collapse-trigger">
      <h2 class="section-title" data-accent="odin" style="margin-bottom:0;">Trade History</h2>
    </div>
    <div class="collapse-body">
      <table class="data-table">
        <thead><tr><th>Time</th><th>Symbol</th><th>Side</th><th>Entry</th><th>Exit</th><th>P&amp;L</th><th>Reason</th><th>Hold</th></tr></thead>
        <tbody id="odin-trades-tbody"><tr><td colspan="8" class="text-muted">No trades yet</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- E: Stats Grid -->
  <div class="grid-6" style="margin-bottom:12px;">
    <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-winrate" style="color:var(--agent-odin);">--</div><div class="stat-label">Win Rate</div></div>
    <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-open-count">0</div><div class="stat-label">Open Pos</div></div>
    <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-trade-count">0</div><div class="stat-label">Trades</div></div>
    <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-drawdown">0%</div><div class="stat-label">Drawdown</div></div>
    <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-consec-losses">0</div><div class="stat-label">Consec Loss</div></div>
    <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-cycle-count">0</div><div class="stat-label">Cycles</div></div>
  </div>

  <!-- F: Circuit Breaker Status -->
  <div class="glass-card" style="margin-bottom:12px;border-left:3px solid var(--agent-odin);">
    <h3 class="section-title" style="font-size:0.72rem;margin-bottom:var(--space-2);text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);">Circuit Breaker</h3>
    <div style="display:flex;align-items:center;gap:12px;">
      <span id="odin-cb-status" style="font-weight:700;font-size:0.82rem;color:var(--success);">TRADING ALLOWED</span>
      <span id="odin-cb-reason" class="text-muted" style="font-size:0.72rem;"></span>
      <span class="text-muted" style="font-size:0.72rem;margin-left:auto;">Size mod: <span id="odin-size-mod">1.0x</span></span>
    </div>
    <div class="grid-3" style="margin-top:8px;">
      <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-daily-pnl">$0.00</div><div class="stat-label">Daily P&amp;L</div><div id="odin-loss-cap-bar" style="margin-top:6px;"></div></div>
      <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-weekly-pnl">$0.00</div><div class="stat-label">Weekly P&amp;L</div></div>
      <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-peak-balance">$1,000</div><div class="stat-label">Peak Balance</div></div>
    </div>
  </div>

  <!-- F1.5: Portfolio Risk Guard (Phase 2) -->
  <div class="glass-card" style="margin-bottom:12px;border-left:3px solid #00d4ff;">
    <h3 class="section-title" style="font-size:0.72rem;margin-bottom:var(--space-2);text-transform:uppercase;letter-spacing:0.06em;color:#00d4ff;">Portfolio Guard</h3>
    <div id="odin-portfolio-guard" style="display:flex;flex-wrap:wrap;gap:8px;">
      <div class="stat-card" data-accent="odin" style="flex:1;min-width:120px;">
        <div class="stat-value" id="odin-pg-heat">0%</div>
        <div class="stat-label">Portfolio Heat</div>
      </div>
      <div class="stat-card" data-accent="odin" style="flex:1;min-width:120px;">
        <div class="stat-value" id="odin-pg-direction">0L / 0S</div>
        <div class="stat-label">Direction Balance</div>
      </div>
      <div class="stat-card" data-accent="odin" style="flex:1;min-width:120px;">
        <div class="stat-value" id="odin-pg-positions">0 / 5</div>
        <div class="stat-label">Open / Max</div>
      </div>
      <div class="stat-card" data-accent="odin" style="flex:1;min-width:120px;">
        <div class="stat-value" id="odin-pg-universe">0</div>
        <div class="stat-label">Coin Universe</div>
      </div>
    </div>
    <div id="odin-pg-exposure" style="margin-top:8px;font-size:0.7rem;color:var(--text-secondary);"></div>
    <div id="odin-pg-blacklist" style="margin-top:4px;font-size:0.7rem;"></div>
  </div>

  <!-- F1.7: WebSocket Status + Pending Orders (Phase 3) -->
  <div class="glass-card" style="margin-bottom:12px;border-left:3px solid #10b981;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
      <h3 class="section-title" style="font-size:0.72rem;margin:0;text-transform:uppercase;letter-spacing:0.06em;color:#10b981;">Real-Time Feed</h3>
      <span id="odin-ws-dot" style="width:8px;height:8px;border-radius:50%;background:#ef4444;"></span>
      <span id="odin-ws-label" style="font-size:0.68rem;color:var(--text-muted);">Disconnected</span>
      <span id="odin-ws-stats" style="font-size:0.64rem;color:var(--text-secondary);margin-left:auto;"></span>
    </div>
    <div id="odin-ws-metrics" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px;">
      <div class="stat-card" data-accent="odin" style="flex:1;min-width:100px;">
        <div class="stat-value" id="odin-ws-tick-age" style="font-size:0.9rem;">--</div>
        <div class="stat-label">Last Tick</div>
      </div>
      <div class="stat-card" data-accent="odin" style="flex:1;min-width:100px;">
        <div class="stat-value" id="odin-ws-events" style="font-size:0.9rem;">0</div>
        <div class="stat-label">Events</div>
      </div>
      <div class="stat-card" data-accent="odin" style="flex:1;min-width:100px;">
        <div class="stat-value" id="odin-ws-pending" style="font-size:0.9rem;">0</div>
        <div class="stat-label">Pending Orders</div>
      </div>
      <div class="stat-card" data-accent="odin" style="flex:1;min-width:100px;">
        <div class="stat-value" id="odin-ws-coins" style="font-size:0.9rem;">0</div>
        <div class="stat-label">Tracked Coins</div>
      </div>
    </div>
    <div id="odin-pending-orders-table" style="font-size:0.7rem;"></div>
  </div>

  <!-- F2: Conviction Engine -->
  <div class="collapse-section default-open">
    <div class="collapse-trigger">
      <h2 class="section-title" data-accent="odin" style="margin-bottom:0;">Conviction Engine (1R Cap) <span id="odin-conviction-badge" class="badge" style="font-size:0.56rem;font-weight:700;padding:2px 8px;border-radius:4px;margin-left:8px;background:rgba(139,92,246,0.15);border:1px solid var(--agent-odin);color:var(--agent-odin);">--/10</span></h2>
    </div>
    <div class="collapse-body">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
        <span style="font-size:0.76rem;font-weight:700;color:var(--agent-odin);">Score: <span id="odin-conv-score">--</span>/100</span>
        <span id="odin-conv-tier" class="badge" style="font-size:0.64rem;padding:2px 8px;border-radius:4px;background:rgba(139,92,246,0.1);color:var(--text-muted);">--</span>
        <span style="font-size:0.72rem;color:var(--text-muted);">Risk mult: <span id="odin-conv-mult">--</span></span>
        <span id="odin-conv-rails" class="text-muted" style="font-size:0.68rem;margin-left:auto;"></span>
      </div>
      <div id="odin-conviction-bars" style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;">
        <div class="text-muted" style="font-size:0.72rem;grid-column:span 2;">No conviction data yet</div>
      </div>
    </div>
  </div>

  <!-- H: Last Signal -->
  <div class="collapse-section">
    <div class="collapse-trigger">
      <h2 class="section-title" data-accent="odin" style="margin-bottom:0;">Last Signal</h2>
    </div>
    <div class="collapse-body">
      <div id="odin-last-signal" class="text-muted" style="font-family:var(--font-mono);font-size:0.74rem;">No signal yet</div>
    </div>
  </div>

  <!-- I2: Journal & Brotherhood Intelligence -->
  <div class="collapse-section">
    <div class="collapse-trigger">
      <h2 class="section-title" data-accent="odin" style="margin-bottom:0;">Journal &amp; Brotherhood</h2>
    </div>
    <div class="collapse-body">
      <div class="grid-6" style="margin-bottom:10px;">
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-j-decisions">0</div><div class="stat-label">Decisions</div></div>
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-j-resolved">0</div><div class="stat-label">Resolved</div></div>
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-j-wr">--</div><div class="stat-label">Memory WR</div></div>
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-j-patterns">0</div><div class="stat-label">Patterns</div></div>
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-j-knowledge">0</div><div class="stat-label">Knowledge</div></div>
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-j-dbsize">0 KB</div><div class="stat-label">DB Size</div></div>
      </div>
      <h3 class="section-title" style="font-size:0.68rem;margin-bottom:6px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;">Brotherhood Intel</h3>
      <div class="grid-6" style="margin-bottom:10px;">
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-b-garves-dir">--</div><div class="stat-label">Garves Dir</div></div>
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-b-garves-wr">--</div><div class="stat-label">Garves WR</div></div>
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-b-garves-streak">0</div><div class="stat-label">Garves Streak</div></div>
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-b-anomaly">OFF</div><div class="stat-label">Anomaly</div></div>
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-b-events">0</div><div class="stat-label">Events Proc</div></div>
        <div class="stat-card" data-accent="odin"><div class="stat-value" id="odin-b-alert">OFF</div><div class="stat-label">Alert</div></div>
      </div>
      <div id="odin-top-patterns" class="text-muted" style="font-size:0.7rem;"></div>
    </div>
  </div>

  <!-- J: Config -->
  <div class="collapse-section">
    <div class="collapse-trigger">
      <h2 class="section-title" data-accent="odin" style="margin-bottom:0;">Config</h2>
    </div>
    <div class="collapse-body">
      <div id="odin-config" class="text-muted" style="font-family:var(--font-mono);font-size:0.72rem;">Loading config...</div>
    </div>
  </div>

</div>

<script>
function odinRefresh() {
  fetch('/api/odin').then(r => r.json()).then(function(d) {
    // Mode
    var isLive = (d.mode || 'paper').toLowerCase() === 'live';
    var modeBadge = document.getElementById('odin-mode-badge');
    if (modeBadge) {
      modeBadge.classList.remove('trading-mode-live', 'trading-mode-paper');
      if (isLive) {
        modeBadge.classList.add('trading-mode-live');
        modeBadge.textContent = 'Trading: Real Money';
      } else {
        modeBadge.classList.add('trading-mode-paper');
        modeBadge.textContent = 'Trading: Paper Money';
      }
    }

    // Hero cards
    odinSetVal('odin-balance', '$' + (d.balance || 1000).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}));
    odinPnl('odin-total-pnl', d.total_pnl || 0);
    odinSetVal('odin-exposure', '$' + (d.total_exposure || 0).toFixed(2));

    // Stats
    odinSetVal('odin-winrate', (d.win_rate || 0).toFixed(1) + '%');
    odinSetVal('odin-open-count', d.open_positions || 0);
    odinSetVal('odin-trade-count', d.trade_count || 0);
    odinSetVal('odin-drawdown', (d.drawdown_pct || 0).toFixed(1) + '%');
    odinSetVal('odin-consec-losses', d.consecutive_losses || 0);
    odinSetVal('odin-cycle-count', d.cycle_count || 0);

    // Circuit breaker
    var cbEl = document.getElementById('odin-cb-status');
    if (cbEl) {
      if (d.trading_allowed) {
        cbEl.textContent = 'TRADING ALLOWED';
        cbEl.style.color = 'var(--success)';
      } else {
        cbEl.textContent = 'PAUSED';
        cbEl.style.color = 'var(--error)';
      }
    }
    odinSetVal('odin-cb-reason', d.cb_reason || '');
    odinSetVal('odin-size-mod', (d.size_modifier || 1).toFixed(2) + 'x');
    odinPnl('odin-daily-pnl', d.daily_pnl || 0);
    odinPnl('odin-weekly-pnl', d.weekly_pnl || 0);
    odinSetVal('odin-peak-balance', '$' + (d.peak_balance || 1000).toFixed(2));

    // Portfolio Guard (Phase 2)
    var pg = d.portfolio_guard || {};
    var pgHeat = pg.total_heat_pct || 0;
    var pgMax = pg.max_heat_pct || 10;
    odinSetVal('odin-pg-heat', pgHeat.toFixed(1) + '% / ' + pgMax + '%');
    var heatEl = document.getElementById('odin-pg-heat');
    if (heatEl) heatEl.style.color = pgHeat > pgMax * 0.8 ? 'var(--error)' : pgHeat > pgMax * 0.5 ? 'var(--warning)' : 'var(--success)';
    odinSetVal('odin-pg-direction', (pg.long_count || 0) + 'L / ' + (pg.short_count || 0) + 'S');
    odinSetVal('odin-pg-positions', (pg.open_positions || 0) + ' / ' + (pg.max_positions || 5));
    var pgCfg = d.config || {};
    odinSetVal('odin-pg-universe', pgCfg.coin_universe || pgCfg.priority_coins || 0);
    var expEl = document.getElementById('odin-pg-exposure');
    if (expEl) {
      var longN = pg.long_notional || 0; var shortN = pg.short_notional || 0;
      expEl.textContent = 'Long: $' + longN.toFixed(0) + ' | Short: $' + shortN.toFixed(0) + ' | Detail slots: ' + (pgCfg.detail_slots || 4) + ' | Per cycle: ' + (pgCfg.symbols_per_cycle || 8);
    }
    var blEl = document.getElementById('odin-pg-blacklist');
    if (blEl) {
      var bl = pg.blacklisted || {};
      var blKeys = Object.keys(bl).filter(function(k) { return bl[k].active; });
      if (blKeys.length > 0) {
        blEl.innerHTML = '<span style="color:var(--error);font-weight:600;">Blacklisted: ' + blKeys.join(', ') + '</span>';
      } else {
        blEl.innerHTML = '<span style="color:var(--success);">No blacklisted coins</span>';
      }
    }

    // WebSocket Status + Pending Orders (Phase 3)
    var ws = d.ws_status || {};
    var wsConnected = ws.connected || false;
    var wsDot = document.getElementById('odin-ws-dot');
    var wsLabel = document.getElementById('odin-ws-label');
    if (wsDot) wsDot.style.background = wsConnected ? '#10b981' : '#ef4444';
    if (wsLabel) wsLabel.textContent = wsConnected ? 'Connected' : 'Disconnected';
    var wsStats = document.getElementById('odin-ws-stats');
    if (wsStats && wsConnected) {
      wsStats.textContent = 'Reconnects: ' + (ws.reconnect_count || 0) + ' | Queue: ' + (ws.queue_size || 0) + ' | Uptime: ' + Math.round((ws.uptime_s || 0) / 60) + 'm';
    }
    var tickAge = ws.last_tick_age_s;
    odinSetVal('odin-ws-tick-age', tickAge >= 0 ? (tickAge < 5 ? 'LIVE' : tickAge.toFixed(0) + 's ago') : '--');
    var tickEl = document.getElementById('odin-ws-tick-age');
    if (tickEl) tickEl.style.color = tickAge >= 0 && tickAge < 5 ? '#10b981' : tickAge > 15 ? 'var(--error)' : 'var(--warning)';
    odinSetVal('odin-ws-events', (ws.events_received || 0).toLocaleString());
    odinSetVal('odin-ws-pending', (d.pending_order_count || 0));
    odinSetVal('odin-ws-coins', ws.cached_coins || 0);

    var pendingOrders = d.pending_orders || [];
    var poDiv = document.getElementById('odin-pending-orders-table');
    if (poDiv) {
      if (pendingOrders.length === 0) {
        poDiv.innerHTML = '<span style="color:var(--text-muted);font-style:italic;">No pending limit orders</span>';
      } else {
        var poHtml = '<table style="width:100%;border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border);color:var(--text-muted);">';
        poHtml += '<th style="text-align:left;padding:3px 6px;">Symbol</th><th>Side</th><th>Price</th><th>Qty</th><th>Age</th><th>TTL</th></tr></thead><tbody>';
        var nowSec = Date.now() / 1000;
        pendingOrders.forEach(function(po) {
          var dirColor = po.direction === 'SHORT' ? 'var(--error)' : 'var(--success)';
          var ageMins = Math.round((nowSec - (po.placed_time || nowSec)) / 60);
          var ttlMins = Math.max(0, Math.round(((po.expires_at || nowSec) - nowSec) / 60));
          poHtml += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">';
          poHtml += '<td style="padding:3px 6px;font-weight:600;">' + (po.symbol || '').replace('USDT', '') + '</td>';
          poHtml += '<td style="text-align:center;color:' + dirColor + ';font-weight:600;">' + (po.direction || '') + '</td>';
          poHtml += '<td style="text-align:center;">$' + (po.limit_price || 0).toFixed(2) + '</td>';
          poHtml += '<td style="text-align:center;">' + (po.qty || 0).toFixed(4) + '</td>';
          poHtml += '<td style="text-align:center;">' + ageMins + 'm</td>';
          poHtml += '<td style="text-align:center;color:' + (ttlMins < 30 ? 'var(--warning)' : 'var(--text-muted)') + ';">' + ttlMins + 'm</td>';
          poHtml += '</tr>';
        });
        poHtml += '</tbody></table>';
        poDiv.innerHTML = poHtml;
      }
    }

    // CoinGlass Regime
    var regime = d.regime || {};
    odinSetVal('odin-regime', (regime.regime || '--').toUpperCase());
    odinSetVal('odin-regime-score', regime.global_score || 50);
    var biasEl = document.getElementById('odin-regime-bias');
    if (biasEl) {
      var bias = regime.direction_bias || 'NONE';
      biasEl.textContent = bias;
      biasEl.style.color = bias === 'SHORT' ? 'var(--error)' : bias === 'LONG' ? 'var(--success)' : 'var(--text-muted)';
    }
    odinSetVal('odin-regime-opps', regime.opportunity_count || (regime.opportunities || []).length || 0);
    odinSetVal('odin-top-short', regime.top_short || '--');
    odinSetVal('odin-top-long', regime.top_long || '--');

    // Opportunities table
    var opps = d.opportunities || [];
    var oppsTbody = document.getElementById('odin-opps-tbody');
    if (oppsTbody) {
      if (opps.length === 0) {
        oppsTbody.innerHTML = '<tr><td colspan="4" class="text-muted">No opportunities detected</td></tr>';
      } else {
        var oppsHtml = '';
        opps.forEach(function(o) {
          var dirColor = o.direction === 'SHORT' ? 'var(--error)' : 'var(--success)';
          oppsHtml += '<tr>';
          oppsHtml += '<td style="font-weight:600;">' + (o.symbol || '') + '</td>';
          oppsHtml += '<td style="color:' + dirColor + ';font-weight:600;">' + (o.direction || '') + '</td>';
          oppsHtml += '<td>' + (o.score || 0) + '</td>';
          oppsHtml += '<td class="text-muted" style="font-size:0.7rem;">' + (o.reasons || []).join(', ') + '</td>';
          oppsHtml += '</tr>';
        });
        oppsTbody.innerHTML = oppsHtml;
      }
    }

    // Positions — fetch live prices then render
    var positions = d.paper_positions || [];
    var tbody = document.getElementById('odin-positions-tbody');
    if (tbody) {
      if (positions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-muted">No open positions</td></tr>';
      } else {
        odinRenderPositions(positions);
      }
    }

    // Last signal
    var sigEl = document.getElementById('odin-last-signal');
    if (sigEl && d.last_signal) {
      var s = d.last_signal;
      var sigColor = s.direction === 'LONG' ? 'var(--success)' : 'var(--error)';
      sigEl.innerHTML = '<span style="color:' + sigColor + ';font-weight:700;">' + (s.direction || '') + '</span> '
        + (s.symbol || '') + ' @ $' + (s.entry_price || 0).toFixed(2)
        + ' | SL: $' + (s.stop_loss || 0).toFixed(2)
        + ' | TP: $' + (s.take_profit_1 || 0).toFixed(2)
        + ' | R:R ' + (s.risk_reward || 0).toFixed(1)
        + ' | Conf: ' + ((s.confidence || 0) * 100).toFixed(0) + '%'
        + ' | Macro: ' + (s.macro_regime || '--')
        + '<br><span class="text-muted">' + (s.entry_reason || '') + '</span>';
    }

    // Config
    var cfgEl = document.getElementById('odin-config');
    if (cfgEl && d.config) {
      var c = d.config;
      cfgEl.innerHTML = 'Exchange: ' + (c.exchange || 'Hyperliquid') + ' (' + (c.hl_pairs || 0) + ' pairs)'
        + ' | Risk: ' + (c.risk_cap || '1R') + ' ($' + (c.risk_per_trade || 150) + ')'
        + ' | R:R: ' + (c.target_rr || 2) + ':1'
        + ' | Max pos: ' + (c.max_positions || 2)
        + ' | CoinGlass: ' + (c.coinglass ? 'ON' : 'OFF')
        + ' | Priority: Top ' + (c.priority_coins || 8)
        + ' | Cycle: ' + (c.cycle_seconds || 300) + 's'
        + ' | Skills: ' + (d.skill_count || 13);
    }

    // Next cycle countdown
    var cycleSec = (d.config || {}).cycle_seconds || 300;
    var lastTs = d.timestamp || 0;
    if (lastTs > 0) {
      window._odinNextCycle = lastTs + cycleSec;
      odinTickCountdown();
      // Flash the timer pill so it's easy to spot
      var pill = document.getElementById('odin-cycle-timer');
      if (pill) {
        pill.scrollIntoView({behavior:'smooth', block:'nearest'});
        pill.style.boxShadow = '0 0 16px rgba(139,92,246,0.6)';
        setTimeout(function(){ pill.style.boxShadow = ''; }, 1500);
      }
    }

    // Intel meter
    if (typeof updateIntelMeter === 'function') {
      var pct = d.running ? 80 : 10;
      if (d.trade_count > 0) pct = Math.min(95, 60 + d.win_rate * 0.3);
      updateIntelMeter('intel-odin', pct, 'var(--agent-odin)');
    }
  }).catch(function(e) {
    console.log('[Odin] Refresh error:', e);
  });

  // Trade history
  fetch('/api/odin/trades').then(r => r.json()).then(function(trades) {
    var tbody = document.getElementById('odin-trades-tbody');
    if (!tbody || !trades.length) return;
    var html = '';
    trades.slice(-20).reverse().forEach(function(t) {
      var pnlColor = t.pnl_usd >= 0 ? 'var(--success)' : 'var(--error)';
      var dirColor = t.side === 'LONG' ? 'var(--success)' : 'var(--error)';
      var exitTime = t.exit_time ? new Date(t.exit_time * 1000).toLocaleString() : '--';
      html += '<tr>';
      html += '<td style="font-size:0.68rem;">' + exitTime + '</td>';
      html += '<td>' + (t.symbol || '') + '</td>';
      html += '<td style="color:' + dirColor + ';">' + (t.side || '') + '</td>';
      html += '<td>$' + (t.entry_price || 0).toFixed(2) + '</td>';
      html += '<td>$' + (t.exit_price || 0).toFixed(2) + '</td>';
      html += '<td style="color:' + pnlColor + ';font-weight:600;">$' + (t.pnl_usd || 0).toFixed(2) + '</td>';
      html += '<td>' + (t.exit_reason || '') + '</td>';
      html += '<td>' + (t.hold_hours || 0).toFixed(1) + 'h</td>';
      html += '</tr>';
    });
    tbody.innerHTML = html;
  }).catch(function(){});

  // Conviction engine
  fetch('/api/odin/conviction').then(r => r.json()).then(function(c) {
    if (!c || !c.active) return;
    var conf110 = c.confidence_1_10 || Math.max(1, Math.min(10, Math.round((c.total_score||0)/10)));
    odinSetVal('odin-conv-score', (c.total_score || 0) + ' (' + conf110 + '/10)');
    odinSetVal('odin-conv-mult', (c.risk_multiplier || 0).toFixed(2) + ' (1R cap)');
    var badge = document.getElementById('odin-conviction-badge');
    if (badge) badge.textContent = conf110 + '/10';
    var tierEl = document.getElementById('odin-conv-tier');
    if (tierEl) {
      tierEl.textContent = c.tier || '--';
      var tierColors = {FULL:'var(--success)',HIGH:'var(--success)',MODERATE:'var(--warning)',LOW:'var(--error)',NO_TRADE:'var(--error)'};
      tierEl.style.color = tierColors[c.tier] || 'var(--text-muted)';
      tierEl.style.borderColor = tierColors[c.tier] || 'var(--text-muted)';
      tierEl.style.border = '1px solid ' + (tierColors[c.tier] || 'var(--text-muted)');
    }
    var railsEl = document.getElementById('odin-conv-rails');
    if (railsEl) railsEl.textContent = (c.safety_adjustments || []).join(', ');
    // Component bars
    var barsEl = document.getElementById('odin-conviction-bars');
    if (barsEl && c.components) {
      var barsHtml = '';
      var compOrder = ['regime_alignment','smc_quality','multi_tf_agreement','macro_support','funding_rate_edge','sentiment_alignment','volume_confirmation','journal_fitness','brother_alignment','risk_reward_quality'];
      compOrder.forEach(function(key) {
        var comp = c.components[key];
        if (!comp) return;
        var raw = comp.raw || 0;
        var weighted = comp.weighted || 0;
        var weight = comp.weight || 0;
        var pct = Math.round(raw * 100);
        var barColor = pct >= 70 ? 'var(--success)' : pct >= 40 ? 'var(--warning)' : 'var(--error)';
        var label = key.replace(/_/g, ' ').replace(/\b\w/g, function(c){return c.toUpperCase();});
        barsHtml += '<div style="padding:4px 6px;background:rgba(139,92,246,0.04);border-radius:4px;">';
        barsHtml += '<div style="display:flex;justify-content:space-between;font-size:0.66rem;margin-bottom:2px;">';
        barsHtml += '<span style="font-weight:600;">' + label + '</span>';
        barsHtml += '<span style="color:' + barColor + ';">' + weighted.toFixed(1) + '/' + weight + '</span></div>';
        barsHtml += '<div style="height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;">';
        barsHtml += '<div style="width:' + pct + '%;height:100%;background:' + barColor + ';border-radius:2px;"></div></div>';
        barsHtml += '<div style="font-size:0.58rem;color:var(--text-muted);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (comp.reason || '') + '</div>';
        barsHtml += '</div>';
      });
      barsEl.innerHTML = barsHtml;
    }
  }).catch(function(){});

  // Journal & Brotherhood
  fetch('/api/odin/journal').then(r => r.json()).then(function(j) {
    if (!j) return;
    odinSetVal('odin-j-decisions', j.total_decisions || 0);
    odinSetVal('odin-j-resolved', j.resolved_decisions || 0);
    odinSetVal('odin-j-wr', (j.win_rate || 0).toFixed(1) + '%');
    odinSetVal('odin-j-patterns', j.active_patterns || 0);
    odinSetVal('odin-j-knowledge', j.total_knowledge || 0);
    odinSetVal('odin-j-dbsize', (j.db_size_kb || 0).toFixed(0) + ' KB');
    var patternsEl = document.getElementById('odin-top-patterns');
    if (patternsEl && j.top_patterns && j.top_patterns.length) {
      var html = '<strong style="font-size:0.66rem;">Learned Patterns:</strong> ';
      j.top_patterns.forEach(function(p) {
        html += '<span style="margin-right:8px;">' + (p.combo || '') + ' (' + ((p.confidence||0)*100).toFixed(0) + '%)</span>';
      });
      patternsEl.innerHTML = html;
    }
  }).catch(function(){});

  fetch('/api/odin/brotherhood').then(r => r.json()).then(function(b) {
    if (!b) return;
    odinSetVal('odin-b-garves-dir', b.garves_direction || '--');
    odinSetVal('odin-b-garves-wr', b.garves_wr != null ? b.garves_wr + '%' : '--');
    odinSetVal('odin-b-garves-streak', b.garves_streak || 0);
    var anomalyEl = document.getElementById('odin-b-anomaly');
    if (anomalyEl) {
      anomalyEl.textContent = b.anomaly_active ? 'ACTIVE' : 'OFF';
      anomalyEl.style.color = b.anomaly_active ? 'var(--error)' : 'var(--success)';
    }
    odinSetVal('odin-b-events', b.events_processed_total || 0);
    var alertEl = document.getElementById('odin-b-alert');
    if (alertEl) {
      alertEl.textContent = b.robotox_alert ? 'ACTIVE' : 'OFF';
      alertEl.style.color = b.robotox_alert ? 'var(--error)' : 'var(--success)';
    }
  }).catch(function(){});
}

function odinSetVal(id, val) {
  var el = document.getElementById(id);
  if (el) el.textContent = val;
}

function odinPnl(id, val) {
  var el = document.getElementById(id);
  if (!el) return;
  var prefix = val >= 0 ? '+$' : '-$';
  el.textContent = prefix + Math.abs(val).toFixed(2);
  el.style.color = val >= 0 ? 'var(--success)' : 'var(--error)';
}

function odinTickCountdown() {
  var el = document.getElementById('odin-cycle-countdown');
  var pill = document.getElementById('odin-cycle-timer');
  if (!el || !window._odinNextCycle) return;
  var now = Date.now() / 1000;
  var diff = Math.max(0, Math.round(window._odinNextCycle - now));
  if (diff <= 0) {
    el.textContent = 'NOW';
    el.style.color = 'var(--success)';
    if (pill) pill.style.boxShadow = '0 0 12px rgba(34,197,94,0.4)';
  } else {
    var m = Math.floor(diff / 60);
    var s = diff % 60;
    el.textContent = m + ':' + (s < 10 ? '0' : '') + s;
    if (diff < 30) {
      el.style.color = 'var(--warning)';
      if (pill) pill.style.boxShadow = '0 0 10px rgba(243,156,18,0.3)';
    } else {
      el.style.color = '';
      if (pill) pill.style.boxShadow = '';
    }
  }
}
var _odinCountdownTick = setInterval(odinTickCountdown, 1000);

var _odinPriceCache = {};

function odinFetchPrices(symbols, cb) {
  var ids = symbols.map(function(s) {
    if (s.indexOf('BTC') >= 0) return 'bitcoin';
    if (s.indexOf('ETH') >= 0) return 'ethereum';
    if (s.indexOf('SOL') >= 0) return 'solana';
    if (s.indexOf('XRP') >= 0) return 'ripple';
    return '';
  }).filter(Boolean);
  if (ids.length === 0) return cb({});
  var unique = ids.filter(function(v, i, a) { return a.indexOf(v) === i; });
  fetch('https://api.coingecko.com/api/v3/simple/price?ids=' + unique.join(',') + '&vs_currencies=usd')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var map = {};
      if (data.bitcoin) map.BTCUSDT = data.bitcoin.usd;
      if (data.ethereum) map.ETHUSDT = data.ethereum.usd;
      if (data.solana) map.SOLUSDT = data.solana.usd;
      if (data.ripple) map.XRPUSDT = data.ripple.usd;
      _odinPriceCache = map;
      cb(map);
    })
    .catch(function() { cb(_odinPriceCache); });
}

function odinRenderPositions(positions) {
  var symbols = positions.map(function(p) { return p.symbol; });
  odinFetchPrices(symbols, function(prices) {
    var tbody = document.getElementById('odin-positions-tbody');
    if (!tbody) return;
    var html = '';
    var totalPnl = 0;
    positions.forEach(function(p) {
      var dirColor = p.direction === 'LONG' ? 'var(--success)' : 'var(--error)';
      var curPrice = prices[p.symbol] || 0;
      var pnl = 0;
      if (curPrice > 0) {
        if (p.direction === 'LONG') {
          pnl = (curPrice - p.entry_price) * p.qty;
        } else {
          pnl = (p.entry_price - curPrice) * p.qty;
        }
      }
      totalPnl += pnl;
      var pnlColor = pnl >= 0 ? 'var(--success)' : 'var(--error)';
      var pnlPrefix = pnl >= 0 ? '+$' : '-$';
      var pnlPct = p.margin > 0 ? (pnl / p.margin * 100) : 0;
      var asset = (p.symbol || '').replace('USDT', '');
      html += '<tr>';
      html += '<td style="font-weight:600;">' + asset + '</td>';
      html += '<td style="color:' + dirColor + ';font-weight:700;">' + (p.direction || '') + '</td>';
      html += '<td>' + (p.leverage || 3) + 'x</td>';
      html += '<td>$' + (p.entry_price || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) + '</td>';
      html += '<td style="font-weight:600;">' + (curPrice > 0 ? '$' + curPrice.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) : '--') + '</td>';
      html += '<td style="color:var(--error);">$' + (p.stop_loss || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) + '</td>';
      html += '<td style="color:var(--success);">$' + (p.take_profit_1 || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) + '</td>';
      html += '<td>' + (p.qty || 0).toFixed(4) + '</td>';
      html += '<td>$' + (p.margin || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) + '</td>';
      html += '<td style="color:' + pnlColor + ';font-weight:700;">' + pnlPrefix + Math.abs(pnl).toFixed(2) + '<div style="font-size:0.58rem;color:' + pnlColor + ';">' + (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%</div></td>';
      html += '</tr>';
    });
    tbody.innerHTML = html;
    var totalEl = document.getElementById('odin-total-pnl');
    if (totalEl && totalPnl !== 0) {
      odinPnl('odin-total-pnl', totalPnl);
    }
  });
}

function odinRunOmniCoin() {
  var input = document.getElementById('odin-omni-input');
  var symbol = (input ? input.value : '').trim().toUpperCase();
  if (!symbol) { alert('Enter a coin symbol (e.g. BTC, ETH)'); return; }

  var section = document.getElementById('odin-omnicoin-section');
  var loading = document.getElementById('odin-omni-loading');
  var sectionsEl = document.getElementById('odin-omni-sections');
  var summaryEl = document.getElementById('odin-omni-summary');

  if (section) section.style.display = 'block';
  if (loading) loading.style.display = 'block';
  if (sectionsEl) sectionsEl.innerHTML = '';
  if (summaryEl) summaryEl.textContent = '';

  fetch('/api/odin/omnicoin', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({symbol: symbol})
  })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    if (loading) loading.style.display = 'none';
    if (d.error) {
      if (summaryEl) summaryEl.textContent = 'Error: ' + d.error;
      return;
    }

    odinSetVal('odin-omni-symbol', d.symbol || symbol);

    var conf = d.confidence || 0;
    var confEl = document.getElementById('odin-omni-confidence');
    if (confEl) {
      confEl.textContent = conf + '/10';
      confEl.style.color = conf >= 7 ? 'var(--success)' : conf >= 4 ? 'var(--warning)' : 'var(--error)';
    }

    var biasEl = document.getElementById('odin-omni-bias');
    if (biasEl) {
      biasEl.textContent = d.bias || '--';
      biasEl.style.background = d.bias === 'LONG' ? 'rgba(46,204,113,0.15)' : d.bias === 'SHORT' ? 'rgba(231,76,60,0.15)' : 'rgba(255,255,255,0.08)';
      biasEl.style.color = d.bias === 'LONG' ? 'var(--success)' : d.bias === 'SHORT' ? 'var(--error)' : 'var(--text-muted)';
    }

    odinSetVal('odin-omni-time', d.timestamp_et || '');
    if (summaryEl) summaryEl.textContent = d.summary || '';

    if (sectionsEl && d.sections) {
      var html = '';
      var sectionNames = {
        'eye_vision': 'Eye Vision', 'regime': 'Regime', 'smc_structure': 'SMC Structure',
        'ob_memory': 'OB Memory', 'liquidity_raids': 'Liquidity Raids', 'sentiment': 'Sentiment',
        'arb_check': 'Cross-Chain Arb', 'stop_hunt_sim': 'Stop Hunt Sim',
        'evolution': 'Self-Evolve', 'journal': 'Journal', 'brotherhood': 'Brotherhood'
      };
      Object.keys(d.sections).forEach(function(key) {
        var sec = d.sections[key];
        var name = sectionNames[key] || key;
        var avail = sec.available;
        var statusColor = avail ? 'var(--success)' : 'var(--text-muted)';
        html += '<div style="padding:8px;background:rgba(139,92,246,0.04);border-radius:6px;border:1px solid rgba(139,92,246,0.1);">';
        html += '<div style="font-size:0.68rem;font-weight:700;color:' + statusColor + ';margin-bottom:4px;">' + (avail ? '&#9679; ' : '&#9675; ') + name + '</div>';
        var details = Object.keys(sec).filter(function(k){ return k !== 'available' && k !== 'error'; });
        details.forEach(function(k) {
          var v = sec[k];
          if (typeof v === 'object' && v !== null) v = JSON.stringify(v).substring(0, 80);
          html += '<div style="font-size:0.62rem;color:var(--text-muted);">' + k + ': <span style="color:var(--text-primary);">' + v + '</span></div>';
        });
        html += '</div>';
      });
      sectionsEl.innerHTML = html;
    }
  })
  .catch(function(e) {
    if (loading) loading.style.display = 'none';
    if (summaryEl) summaryEl.textContent = 'Analysis failed: ' + e;
  });
}

// Load last OmniCoin result on tab switch
function odinLoadLastOmni() {
  fetch('/api/odin/omnicoin').then(function(r) { return r.json(); }).then(function(d) {
    if (d && d.symbol) {
      var section = document.getElementById('odin-omnicoin-section');
      if (section) section.style.display = 'block';
      odinSetVal('odin-omni-symbol', d.symbol);
      var confEl = document.getElementById('odin-omni-confidence');
      if (confEl) confEl.textContent = (d.confidence || 0) + '/10';
      var biasEl = document.getElementById('odin-omni-bias');
      if (biasEl) biasEl.textContent = d.bias || '--';
      odinSetVal('odin-omni-time', d.timestamp_et || '');
      var summaryEl = document.getElementById('odin-omni-summary');
      if (summaryEl) summaryEl.textContent = d.summary || '';
    }
  }).catch(function(){});
}

// Auto-refresh when tab is active (30s interval)
var _odinInterval = null;
(function() {
  var _origLoadOdin = window.loadOdinTab;
  window.loadOdinTab = function() {
    odinRefresh();
    odinLoadLastOmni();
    if (_odinInterval) clearInterval(_odinInterval);
    _odinInterval = setInterval(odinRefresh, 30000);
  };
  // Clear interval when leaving tab
  var _origSwitch = window.switchTab;
  if (_origSwitch) {
    window.switchTab = function(tab) {
      if (tab !== 'odin' && _odinInterval) { clearInterval(_odinInterval); _odinInterval = null; }
      _origSwitch(tab);
    };
  }
})();
</script>
